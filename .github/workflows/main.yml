name: Deploy to Amazon EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Production Deployment
    runs-on: 3t  

    steps:
      - name: Cleanup Workspace
        run: |
          sudo rm -rf ${{ github.workspace }}/*
          sudo rm -rf ${{ github.workspace }}/.* || true

      - name: Clone Repository
        run: |
          # Uses your PAT to clone the private repo
          git clone https://${{ secrets.GH_PAT }}@github.com/Jaygohel164/3-iter-project.git .

      - name: Setup Backend Environment
        run: |
          cat <<EOF > backend/.env
          AUTO_MIGRATE=true
          NODE_ENV=production
          SERVER_PORT=3500
          API_PREFIX=/api/v1
          CORS_ORIGIN=*
          
          # Database & Infrastructure (Hardcoded as requested)
          DATABASE_URL=postgres://postgres:s!6hacls1briPhIph%2B6l@dev-gnostic.cn8wmm0i46k9.ap-south-1.rds.amazonaws.com:5432/dev_gdnostic
          REDIS_URL=redis://gnosticpass@65.1.130.47:6379/0
          
          # RTC Configuration using your EC2_HOST secret
          MEDIASOUP_ANNOUNCED_IP=${{ secrets.EC2_HOST }}
          MEDIASOUP_LISTEN_IP=0.0.0.0
          MEDIASOUP_RTC_MIN_PORT=47000
          MEDIASOUP_RTC_MAX_PORT=47099
          EOF

      - name: Setup Frontend Environment
        run: |
          cat <<EOF > frontend/.env
          # Using EC2_HOST secret for the frontend to find the backend
          VITE_API_URL=http://${{ secrets.EC2_HOST }}:3500/api/v1
          VITE_SOCKET_URL=http://${{ secrets.EC2_HOST }}:3500
          EOF

      - name: Docker Orchestration
        run: |
          # Clean build cache to prevent disk space errors
          sudo docker builder prune -f
          sudo docker compose build --no-cache
          sudo docker compose down --remove-orphans
          sudo docker compose up -d

      - name: Deployment Status
        run: |
          echo "Deployment successful to ${{ secrets.EC2_HOST }} as ${{ secrets.EC2_USERNAME }}"
          sudo docker ps
